#include "ControlLoop.h"

// number of active cells
int CellNum = 6;
const int CN = 6;

// assign sensor pins
int readPin[CN] = {A4,A2,A0,A3,A1,A6};

// assign valve pins
int bagPin[CN*2][2] = {
    {40,39},{42,43},
    {34,35},{36,37},
    {6,7},{8,9},
    {28,31},{32,33},
    {2,3},{4,5},
    {44,45},{46,47}
};

// adapted to 13V power supply, 15~20 psi air pressure
unsigned long constCellsPulseLength[CN][2] = {{4500, 4500}, {4500, 4500}, {4500, 4500}, {4500, 4500}, {4500, 4500}, {4500, 4500}};
unsigned long cellsPulseLength[CN][2] = {{4500, 4500}, {4500, 4500}, {4500, 4500}, {4500, 4500}, {4500, 4500}, {4500, 4500}};

// target angles
float angleSteps[25][CN] = {
    // stored in degrees, pre-computed to save calculation time
    {90.00,	90.00,	90.00,	90.00,	90.00,	90.00},
    {92.47,	86.39,	85.07,	85.07,	92.42,	88.68},
    {94.00,	86.05,	81.16,	81.16,	91.54,	84.30},
    {95.08,	85.30,	79.95,	79.95,	89.36,	83.74},
    {94.13,	86.90,	83.14,	83.14,	85.60,	85.14},
    {91.97,	89.38,	88.66,	88.66,	82.48,	89.06},
    {89.79,	91.55,	93.59,	93.59,	81.16,	92.77},
    {89.07,	92.06,	94.70,	94.70,	82.07,	93.46},
    {90.80,	87.86,	89.67,	89.67,	86.14,	93.50},
    {93.63,	87.02,	83.25,	83.25,	87.84,	85.29},
    {97.92,	81.70,	75.00,	75.00,	90.79,	83.07},
    {102.64,74.80,	70.56,	70.56,	92.53,	83.48},
    {102.90,74.91,	69.31,	69.31,	90.92,	84.76},
    {101.62,79.83,	73.14,	73.14,	87.36,	83.08},
    {97.06,	83.75,	78.01,	78.01,	85.82,	82.97},
    {95.29,	85.48,	80.43,	80.43,	87.06,	83.82},
    {95.29,	84.89,	79.25,	79.25,	90.33,	83.50},
    {97.37,	81.55,	74.52,	74.52,	94.84,	83.22},
    {102.19,74.21,	69.23,	69.23,	99.66,	84.57},
    {105.08,69.41,	65.41,	65.41,	101.65,	86.90},
    {104.32,71.10,	66.43,	66.43,	98.98,	86.33},
    {99.41,	79.29,	72.46,	72.46,	93.00,	83.60},
    {94.57,	85.97,	81.17,	81.17,	88.60,	84.21},
    {91.35,	89.17,	88.07,	88.07,	87.47,	88.60},
    {89.65,	90.57,	91.36,	91.36,	88.21,	91.01}
};

float mAngleSteps[24][CN] = {
    {90.00, 90.00,  90.00, 90.00, 90.00,  90.00},
    {93.25, 91.95,  84.14, 84.14, 99.44,  95.53},
    {91.95,	93.91,  84.79, 81.54,	97.81,  96.84},
    {90.98,	93.91,  83.49, 77.96,	98.14,  99.76},
    {90.98,	91.63,  80.89, 73.07,	97.81,  100.74},
    {91.30,	89.02,  80.24, 78.93,	92.93,  94.56},
    {91.95,	89.02,  83.82, 85.12,	93.25,  95.53},
    {91.95,	94.23,  88.05, 90.98,	94.23,  95.53},
    {91.30,	104.65, 92.93, 94.56,	102.69, 94.88},
    {88.70,	104.00, 95.21, 98.14,	105.62, 96.51},
    {88.37,	103.67, 94.23, 95.86,	105.62, 96.84},
    {88.37,	101.07, 92.60, 91.30,	105.62, 98.46},
    {90.00,	98.46,	89.02, 85.12,	99.76,  101.07},
    {94.56,	97.49,	87.72, 89.35,	99.76,  95.53},
    {94.88,	98.79,	90.00, 92.28,	104.65, 94.56},
    {94.88,	103.02, 92.60, 94.56,	104.65, 92.93},
    {94.23,	104.65, 92.60, 94.56,	104.97, 96.51},
    {94.23,	103.35, 91.30, 89.02,	104.32, 98.46},
    {94.23,	90.33,	83.16, 73.07,	100.09, 102.37},
    {95.21,	83.16,	80.24, 72.10,	93.91,  100.42},
    {96.18,	82.51,	78.93, 72.75,	94.23,  94.56},
    {96.18,	86.75,	79.26, 75.35,	97.16,  96.51},
    {96.18,	91.63,	82.19, 79.58,	98.14,  98.46},
    {94.56,	94.88,	84.14, 81.21,	98.46,  99.11}
};

int stepSize = 24;
ControlLoop cl(CellNum, readPin, bagPin, constCellsPulseLength, cellsPulseLength, stepSize);

void setup() {
    // use a high baud rate for quicker serial communication
    Serial.begin(2000000);
    
    for (int i=0; i<stepSize; ++i) {
        for (int j=0; j<CellNum; ++j) {
            cl.angleSteps[i][j] = mAngleSteps[i][j];
            Serial.println(cl.angleSteps[i][j]);
        }
    }
    
    // cl.setup();
}

void loop() {
    // cl.loop();
}